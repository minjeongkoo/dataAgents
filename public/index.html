<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>LiDAR Viewer</title>
  <style>body{margin:0;overflow:hidden;}canvas{display:block;}</style>
</head>
<body>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 0, 5);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

let pointsMesh = null;

function renderPoints(pts) {
  if (pointsMesh) scene.remove(pointsMesh);

  const pos = new Float32Array(pts.length * 3);
  const col = new Float32Array(pts.length * 3);
  pts.forEach((p, i) => {
    pos[3*i]   = p.x;
    pos[3*i+1] = p.y;
    pos[3*i+2] = p.z;

    const [r, g, b] = layerColor(p.layer);
    col[3*i]   = r;
    col[3*i+1] = g;
    col[3*i+2] = b;
  });

  const geometry = new THREE.BufferGeometry();
  geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));
  geometry.setAttribute('color',    new THREE.BufferAttribute(col, 3));

  const material = new THREE.PointsMaterial({ size: 0.05, vertexColors: true });
  pointsMesh = new THREE.Points(geometry, material);
  scene.add(pointsMesh);
}

function layerColor(layer) {
  const cmap = [
    [1, 0, 0], [0, 1, 0], [0, 0, 1], [1, 1, 0],
    [0, 1, 1], [1, 0, 1], [1, 0.5, 0], [0.5, 0.5, 0.5],
    [0.6, 0.3, 0.9], [0.2, 0.8, 0.3], [0.9, 0.2, 0.5], [0.3, 0.3, 0.9],
    [0.9, 0.6, 0.1], [0.5, 0.9, 0.9], [0.7, 0.1, 0.9], [0.2, 0.2, 0.2]
  ];
  return cmap[layer % cmap.length];
}

function fetchScanData() {
  fetch('/scan')
    .then(res => {
      if (!res.ok) throw new Error("No data yet");
      return res.json();
    })
    .then(data => renderPoints(data))
    .catch(err => console.warn(err.message));
}

// 2초마다 요청
setInterval(fetchScanData, 2000);

function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
