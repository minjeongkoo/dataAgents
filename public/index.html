<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>LiDAR 360° Cluster Viewer</title>
  <style>
    body { margin:0; overflow:hidden; }
    canvas { display:block; }
    .label {
      font-family: sans-serif;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 2px 4px;
      border-radius: 2px;
      white-space: nowrap;
    }
  </style>

  <!-- importmap 으로 three.js 모듈 경로 지정 -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js"
    }
  }
  </script>
</head>

<body>
<script type="module">
  import * as THREE from 'three';
  import { CSS2DRenderer, CSS2DObject }
    from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/renderers/CSS2DRenderer.js';

  const WS_URL = `ws://${location.host}/ws`;

  // 성능 튜닝: 한 프레임당 최대 표시 포인트 수
  const MAX_DISPLAY_POINTS = 15000;

  let MAX_POINTS = 0;
  let positions  = new Float32Array(0);
  let colors     = new Float32Array(0);

  const clusterColorMap = new Map();
  const prevCenters     = new Map();
  let lastFrameTime     = performance.now();

  // Three.js 기본 세팅
  const scene    = new THREE.Scene();
  const camera   = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
  camera.position.set(0, 0, 5);
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  document.body.appendChild(renderer.domElement);

  // CSS2DRenderer (레이블 표시용)
  const labelRenderer = new CSS2DRenderer();
  labelRenderer.setSize(innerWidth, innerHeight);
  labelRenderer.domElement.style.position = 'absolute';
  labelRenderer.domElement.style.top      = '0';
  document.body.appendChild(labelRenderer.domElement);

  // 버퍼 지오메트리 + 포인트 메쉬
  const geometry = new THREE.BufferGeometry();
  geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  geometry.setAttribute('color',    new THREE.BufferAttribute(colors,    3));
  geometry.setDrawRange(0, 0);
  const material   = new THREE.PointsMaterial({ size:0.03, vertexColors: true });
  const pointsMesh = new THREE.Points(geometry, material);
  scene.add(pointsMesh);

  // 클러스터 박스·레이블·화살표 그룹
  const clusterGroup = new THREE.Group();
  scene.add(clusterGroup);

  // 리사이즈 대응
  window.addEventListener('resize', () => {
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
    labelRenderer.setSize(innerWidth, innerHeight);
  });

  // WebSocket 연결
  const socket = new WebSocket(WS_URL);
  socket.addEventListener('open',  () => console.log('WS connected'));
  socket.addEventListener('close', () => console.log('WS disconnected'));
  socket.addEventListener('message', ({ data }) => {
    const pts = JSON.parse(data);
    const rawCount = pts.length;
    if (rawCount === 0) return;

    // ↓ 다운샘플링 (성능)
    const skip = rawCount > MAX_DISPLAY_POINTS
               ? Math.ceil(rawCoun
