<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LiDAR 3D Rings</title>
  <style>body{margin:0}canvas{display:block}</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const scene    = new THREE.Scene()
const camera   = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, .1, 1000)
const renderer = new THREE.WebGLRenderer({antialias:true})
renderer.setSize(innerWidth, innerHeight)
document.body.appendChild(renderer.domElement)

camera.position.set(0,50,100)
scene.add(new THREE.GridHelper(200,20))
scene.add(new THREE.AxesHelper(50))

let ringMeshes = []

function drawRings(points) {
  // 기존 링 제거
  ringMeshes.forEach(m=> scene.remove(m))
  ringMeshes = []

  // 레이어별 포인트 묶기
  const byLayer = {}
  points.forEach(p => {
    (byLayer[p.layer]||=(byLayer[p.layer]=[])).push(p)
  })

  Object.keys(byLayer).forEach(layerIdx => {
    const pts = byLayer[layerIdx]
    // θ = atan2(y,x) 기준 정렬
    pts.sort((a,b)=> Math.atan2(a.y,a.x) - Math.atan2(b.y,b.x))
    const pos = new Float32Array(pts.length*3)
    for(let i=0;i<pts.length;i++){
      pos[i*3]=pts[i].x
      pos[i*3+1]=pts[i].z  // 화면에서 z축을 세로로 보려면 y<->z 스왑
      pos[i*3+2]=pts[i].y
    }
    const geo = new THREE.BufferGeometry()
    geo.setAttribute('position', new THREE.BufferAttribute(pos,3))
    // 레이어별 색: HSL hue 분할
    const hue = layerIdx/ Object.keys(byLayer).length
    const color = new THREE.Color().setHSL(hue,1,0.5)
    const mat = new THREE.LineBasicMaterial({ color })
    const line = new THREE.LineLoop(geo, mat)
    ringMeshes.push(line)
    scene.add(line)
  })
}

const socket = io()
socket.on('lidar-points', pts => drawRings(pts))

function animate(){
  requestAnimationFrame(animate)
  renderer.render(scene,camera)
}
animate()

window.addEventListener('resize',()=>{
  camera.aspect = innerWidth/innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize(innerWidth,innerHeight)
})
</script>
</body>
</html>
