<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LiDAR Viewer</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // Three.js 초기 설정
    const scene    = new THREE.Scene()
    const camera   = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000)
    camera.position.set(0, 0, 100)
    const renderer = new THREE.WebGLRenderer({ antialias: true })
    renderer.setSize(window.innerWidth, window.innerHeight)
    document.body.appendChild(renderer.domElement)

    // 그리드와 축 도우미
    scene.add(new THREE.GridHelper(200, 20))
    scene.add(new THREE.AxesHelper(100))

    let pointsMesh = null

    // UDP→WebSocket으로 받은 포인트 업데이트
    function updatePoints(points) {
      if (!Array.isArray(points) || points.length === 0) return

      const verts = new Float32Array(points.length * 3)
      for (let i = 0; i < points.length; i++) {
        verts[i*3]   = points[i].x
        verts[i*3+1] = points[i].y
        verts[i*3+2] = points[i].z
      }

      const geo = new THREE.BufferGeometry()
      geo.setAttribute('position', new THREE.BufferAttribute(verts, 3))
      const mat = new THREE.PointsMaterial({ size: 2, color: 0xff44aa })

      if (pointsMesh) scene.remove(pointsMesh)
      pointsMesh = new THREE.Points(geo, mat)
      scene.add(pointsMesh)
    }

    // WebSocket 연결
    const socket = io()
    socket.on('connect', () => console.log('[WS] Connected'))
    socket.on('lidar-points', updatePoints)

    // 애니메이션 루프
    function animate() {
      requestAnimationFrame(animate)
      renderer.render(scene, camera)
    }
    animate()

    // 창 크기 변경 대응
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight
      camera.updateProjectionMatrix()
      renderer.setSize(window.innerWidth, window.innerHeight)
    })
  </script>
</body>
</html>
