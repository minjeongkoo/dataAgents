<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Live 3D Lidar Point Cloud (Improved)</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <h2>Live 3D Lidar Point Cloud (Smooth)</h2>
    <div id="plot" style="width: 100%; height: 90vh;"></div>

    <script>
        const socket = new WebSocket('ws://' + location.host);

        let layout = {
            title: '3D Lidar Point Cloud',
            scene: {
                xaxis: {
                    title: 'X (mm)',
                    range: [-20000, 20000],   // Xì¶• ë²”ìœ„ ê³ ì • (-20m ~ +20m)
                },
                yaxis: {
                    title: 'Y (mm)',
                    range: [-20000, 20000],   // Yì¶• ë²”ìœ„ ê³ ì •
                },
                zaxis: {
                    title: 'Z (mm)',
                    range: [-5000, 5000],     // Zì¶• ë²”ìœ„ ê³ ì • (ìˆ˜ì§ë°©í–¥, ë³´í†µ -5m ~ +5m ì¶©ë¶„)
                },
                aspectmode: 'manual',       // ë¹„ìœ¨ ìˆ˜ë™ ê³ ì •
                aspectratio: { x: 1, y: 1, z: 0.5 } // X:Y:Z ë¹„ìœ¨ ì¡°ì • (Zë¥¼ ì¡°ê¸ˆ ëˆŒëŸ¬ì„œ ë³´ì—¬ì¤Œ)
            },
            margin: { t: 40 }
        };


        let lidarPoint = {
            x: [0],
            y: [0],
            z: [0],
            mode: 'markers',
            type: 'scatter3d',
            marker: {
                size: 5,
                color: 'black'
            },
            name: 'Lidar Position'
        };

        let lidarData = [lidarPoint, {
            x: [],
            y: [],
            z: [],
            mode: 'markers',
            type: 'scatter3d',
            marker: {
                size: 2,
                color: [],
                colorscale: 'Viridis',
                opacity: 0.8
            },
            name: 'Points'
        }];

        Plotly.react('plot', lidarData, layout);

        socket.onopen = () => {
            console.log('WebSocket connected.');
        };

        socket.onmessage = (event) => {
            const points = JSON.parse(event.data);
            const x = points.map(p => p.x);
            const y = points.map(p => p.y);
            const z = points.map(p => p.z);

            lidarData[1].x = x;
            lidarData[1].y = y;
            lidarData[1].z = z;
            lidarData[1].marker.color = z; // Zì¶• ë†’ì´ì— ë”°ë¼ ìƒ‰ê¹” ë§¤í•‘

            Plotly.react('plot', lidarData, layout); // ðŸš€ react() ì‚¬ìš©ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ
        };

        socket.onclose = () => {
            console.log('WebSocket disconnected.');
        };
    </script>
</body>

</html>